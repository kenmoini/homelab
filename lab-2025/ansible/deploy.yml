---
- name: Deploy Services
  hosts: labcore

  vars:
    container_root_dir: /opt/caas

    podman_bridge_name: lanBridge

    ghcr_pull_auth_file: /opt/ghcr.io.json

    # =============================================================
    # Pihole
    deploy_pihole: false
    pihole_ip_address: 192.168.42.12
    pihole_admin_password: notpassword
    pihole_timezone: America/New_York
    pihole_admin_email: ken@kenmoini.com
    pihole_upstream_dns_servers:
      - 208.67.220.220
      - 208.67.222.222
    pihole_temperature_unit: f

    # =============================================================
    # PowerDNS
    deploy_pdns: false
    pdns_ip_address: 192.168.42.11

    pdns_upstream_servers:
      - 192.168.42.12

    pdns_forward_zones:
      - name: kemo.labs
        server: "{{ pdns_ip_address }}:5300"
      - name: kemo.network
        server: "{{ pdns_ip_address }}:5300"
      - name: kemo.edge
        server: "192.168.99.2:53"

    # =============================================================
    # Chronyd - needs host network access
    deploy_chronyd: false
    #chronyd_servers:
    #  - 192.168.42.61
    #  - 192.168.42.62
    #  - 192.168.42.63

    # =============================================================
    # Squid Proxy
    deploy_squid: true
    squid_ip_address: 192.168.42.18
    squid_hostname: proxy.kemo.labs

  # ===============================================================
  tasks:
    - name: Create Service Containers Directory
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
      with_items:
        - "{{ container_root_dir }}"
        - "{{ container_root_dir }}/squid"
        - "{{ container_root_dir }}/step-ca"
        - "{{ container_root_dir }}/npm-ingress"
        - "{{ container_root_dir }}/sso"
        - "{{ container_root_dir }}/vault"
        - "{{ container_root_dir }}/o11y"

    - name: Deploy PiHole
      when: deploy_pihole|bool
      ansible.builtin.include_role:
        name: pihole

    - name: Deploy Chronyd
      when: deploy_chronyd|bool
      ansible.builtin.include_role:
        name: chronyd

    - name: Deploy PowerDNS
      when: deploy_pdns|bool
      ansible.builtin.include_role:
        name: powerdns

    - name: Deploy Squid Outbound Proxy
      when: deploy_squid|bool
      ansible.builtin.include_role:
        name: squid